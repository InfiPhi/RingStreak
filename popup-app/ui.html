<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RingStreak</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --text:#eef2ff; --muted:#9aa3b2; --accent:#6aa4ff; }
    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ padding:16px; }
    .card{ background:var(--card); border-radius:14px; padding:14px 16px; box-shadow: 0 4px 24px rgba(0,0,0,.35); }
    .title{ font-size:20px; font-weight:800; margin:0 0 6px; }
    .sub{ color:var(--muted); margin:2px 0; font-size:13px; }
    .row{ margin-top:10px; }
    .label{ color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.06em; }
    .val{ font-size:15px; margin-top:3px; }
    .link{ color:var(--accent); text-decoration:none; word-break: break-all; }
    .list{ margin-top:12px; max-height:240px; overflow:auto; }
    .item{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.06); margin-bottom:8px; }
    .stage{ color:#a3d9a5; font-size:12px; }
    .muted{ color:var(--muted); }
    .preview{ margin-top:6px; color:var(--muted); font-size:12px; }
    .header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .tag{ background:#1c2750; color:#cbd6ff; border-radius:999px; padding:4px 8px; font-size:11px; }
    .kv{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill{ background:#1b2444; padding:3px 8px; border-radius:999px; font-size:12px; color:#cfd7f9; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="title" id="project">—</div>
        <div class="tag" id="direction">Inbound</div>
      </div>

      <div class="sub" id="contact">—</div>
      <div class="sub" id="company">—</div>
      <div class="kv sub" id="contactMeta"></div>

      <div class="row">
        <div class="label">Stage</div>
        <div class="val" id="stage">—</div>
      </div>

      <div class="row">
        <div class="label">Link</div>
        <div class="val"><a class="link" id="link" href="#" target="_blank">Open in Streak</a></div>
      </div>

      <div class="row">
        <div class="label">Last email</div>
        <div class="val" id="lastSubject">—</div>
        <div class="muted" id="lastWhen"></div>
        <div class="preview" id="preview"></div>
      </div>
    </div>

    <div class="row" style="margin-top:14px;">
      <div class="label">Other matches</div>
      <div class="list" id="others"></div>
    </div>
  </div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const UID = params.get("uid") || "";
  const SIGN_IN_URL = params.get("signIn") || "";
  const AUTO_SIGN_IN = params.get("auto") === "1";

  function withUser(urlString) {
    if (!urlString) return "";
    try {
      const u = new URL(urlString);
      if (UID) u.searchParams.set("uid", UID);
      return u.toString();
    } catch {
      return urlString;
    }
  }

  const EVENTS_URL = withUser(params.get("events"));
  const AUTH_STATUS_URL = withUser(params.get("auth") || "");

  const els = {
    project: document.getElementById("project"),
    contact: document.getElementById("contact"),
    company: document.getElementById("company"),
    contactMeta: document.getElementById("contactMeta"),
    stage: document.getElementById("stage"),
    link: document.getElementById("link"),
    lastSubject: document.getElementById("lastSubject"),
    lastWhen: document.getElementById("lastWhen"),
    preview: document.getElementById("preview"),
    others: document.getElementById("others"),
    direction: document.getElementById("direction")
  };

  function pill(text){
    const span = document.createElement("span");
    span.className = "pill";
    span.textContent = text;
    return span;
  }
  function truncate(s, n){ return (s && s.length>n) ? s.slice(0,n-1)+"…" : (s||""); }
  function fmtWhen(iso){
    if (!iso) return "";
    try{ return new Date(iso).toLocaleString(); }catch{ return ""; }
  }

  function render(payload){
    const t = payload?.top;
    els.direction.textContent = (payload?.direction||"").replace(/\b\w/g, c=>c.toUpperCase());

    if (!t) {
      els.project.textContent = "Contact not found in StreakCRM";
      els.contact.textContent = "";
      els.company.textContent = "";
      els.contactMeta.innerHTML = "";
      els.stage.textContent = "—";
      els.link.href = "#";
      els.link.textContent = "—";
      els.link.classList.add("muted");
      els.link.removeAttribute("target");
      els.lastSubject.textContent = "—";
      els.lastWhen.textContent = "";
      els.preview.textContent = "";
    } else {
      const contactOnly = Boolean(t.contactOnly);
      const hasLink = Boolean(t.link);
      els.project.textContent = t.project || (contactOnly ? t.contact || "Known contact" : "—");
      els.contact.textContent = t.contact ? `Contact: ${t.contact}` : "";
      els.company.textContent = t.company ? `Company: ${t.company}` : "";

      els.contactMeta.innerHTML = "";
      if (t.contactEmail) els.contactMeta.appendChild(pill(t.contactEmail));
      if (Array.isArray(t.contactPhones) && t.contactPhones.length) {
        els.contactMeta.appendChild(pill(t.contactPhones.join(" · ")));
      }

      els.stage.textContent = contactOnly ? "No linked box yet" : t.stage || "—";
      els.link.textContent = contactOnly ? "Open contact in Streak" : "Open in Streak";
      els.link.href = hasLink ? t.link : "#";
      if (hasLink) {
        els.link.setAttribute("target", "_blank");
        els.link.classList.remove("muted");
      } else {
        els.link.removeAttribute("target");
        els.link.classList.add("muted");
      }
      els.lastSubject.textContent = t.lastEmailSubject || "—";
      els.lastWhen.textContent = fmtWhen(t.lastEmailAt) || "";
      els.preview.textContent = t.preview ? truncate(String(t.preview), 220) : "";
    }

    els.others.innerHTML = "";
    (payload?.others||[]).forEach(o=>{
      const div = document.createElement("div");
      div.className = "item";
      const a = document.createElement("a");
      a.href = o.link || "#";
      a.target = "_blank";
      a.className = "link";
      a.textContent = o.project || "(Untitled)";
      const stage = document.createElement("div");
      stage.className = "stage";
      stage.textContent = o.stage || o.stageName || "";
      div.appendChild(a);
      div.appendChild(stage);
      els.others.appendChild(div);
    });

    if (window.ringstreak && typeof window.ringstreak.show === "function") {
      window.ringstreak.show();
    }
  }

  // Allow the tray menu "Show Test Popup" to bring window up even before any events
  if (window.ringstreak && typeof window.ringstreak.onTest === "function") {
    window.ringstreak.onTest(() => {
      if (window.ringstreak && typeof window.ringstreak.show === "function") {
        window.ringstreak.show();
      }
    });
  }

  let es;
  let esErrorCount = 0;
  let lastSignIn = 0;

  function maybeLaunchSignIn() {
    if (!SIGN_IN_URL || !AUTO_SIGN_IN) return;
    const now = Date.now();
    if (now - lastSignIn < 60_000) return;
    lastSignIn = now;
    window.open(SIGN_IN_URL, "_blank");
  }

  async function checkAuthStatus(triggerSignIn = false) {
    if (!AUTH_STATUS_URL) return { signedIn: true };
    try {
      const resp = await fetch(AUTH_STATUS_URL, { credentials: "omit" });
      const json = await resp.json().catch(() => ({}));
      const signedIn = Boolean(json?.signedIn);
      if (!signedIn && triggerSignIn) maybeLaunchSignIn();
      return { signedIn, expiresAt: json?.expiresAt };
    } catch {
      if (triggerSignIn) maybeLaunchSignIn();
      return { signedIn: false };
    }
  }

  function startEvents(){
    if (!EVENTS_URL) return;
    if (es) es.close();
    esErrorCount = 0;
    es = new EventSource(EVENTS_URL, { withCredentials:false });
    es.addEventListener("call", (ev)=> {
      try{ render(JSON.parse(ev.data)); }catch(_){}
    });
    es.addEventListener("ping", ()=>{});
    es.onopen = () => { esErrorCount = 0; };
    es.onerror = () => {
      esErrorCount += 1;
      if (esErrorCount >= 3) {
        esErrorCount = 0;
        checkAuthStatus(true);
      }
    };
  }

  checkAuthStatus(true).finally(() => startEvents());
  setInterval(() => checkAuthStatus(true), 60_000);
})();
</script>
</body>
</html>
